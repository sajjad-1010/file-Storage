# File Storage Service – راهنمای جامع

## معماری کلی
- **NestJS + Fastify** برای راه‌اندازی HTTP server سبک و سریع.
- **پردازش استریم**: از `busboy` برای خواندن `multipart/form-data` بدون بافر کامل در حافظه استفاده می‌شود.
- **تعیین نوع فایل**: بسته `file-type` روی بایت‌های ابتدایی فایل اجرا می‌شود تا MIME واقعی مشخص شود.
- **ماژول‌های تخصصی**:
  - `UploadModule`: کنترل احراز هویت، محدودیت حجم، و هدایت پردازش.
  - `ImageModule`: نرمال‌سازی تصاویر با `sharp` و تولید thumbnail.
  - `VideoModule`: بررسی مدت ویدیو با `ffprobe`، حذف متادیتا با `ffmpeg`، ساخت thumbnail.
  - `MediaModule`: DTOها، انواع مشترک، و ابزارهای محاسبه SHA-256 و مسیرهای تاریخ‌محور.
  - `TasksModule`: وظایف background مثل پاکسازی فایل‌های موقت.
- **ذخیره‌سازی**:
  - پوشه اصلی `BASE_DIR`.
  - فایل موقت: `TMP_DIR`.
  - نسخه‌ی نهایی: `ORIG_DIR` (ساختار `o/YYYY/MM/DD/<sha>.<ext>`).
  - thumbnail: `THUMB_DIR` (ساختار `t/YYYY/MM/DD/<sha>.jpg`).
  - مسیرها بر اساس زمان UTC تولید می‌شوند.

## جریان آپلود
1. دریافت درخواست `POST /upload` با هدر `Authorization: Bearer <JWT>`.
2. اعتبارسنجی JWT: وجود `sub`, `kind`, `maxSize`, `exp`, و `maxVideoSec` (≤ ۶۰).
3. خواندن استریم و نوشتن بر روی فایل موقت.
4. کنترل حجم در دو سطح: `MAX_UPLOAD_MB` و `maxSize` از توکن.
5. تشخیص MIME واقعی و مقایسه با لیست مجاز (بر اساس `kind`).
6. بر اساس نوع:
   - **تصویر**: چرخش فیزیکی، حذف متادیتا، خروجی در قالب اولیه، تولید thumbnail JPEG.
   - **ویدیو**: بررسی مدت؛ اگر بیش از حد، خطای `413`. حذف متادیتا با `ffmpeg -map_metadata -1`. تلاش برای `-c copy` و در صورت نیاز encode مجدد H.264/AAC. استخراج thumbnail در فریم ۰٫۵ ثانیه.
7. محاسبه SHA-256 روی فایل نهایی؛ اگر قبلاً موجود باشد، همان مسیرها برگشت داده می‌شوند.
8. حذف فایل موقت.
9. پاسخ JSON شامل مسیرهای ذخیره‌سازی و متادیتای استخراج‌شده.

## امنیت و کنترل‌ها
- JWT با کلید عمومی یا shared secret (`JWT_ALG`) بررسی می‌شود.
- محدودیت حجم کلی (`MAX_UPLOAD_MB`) و محدودیت اختصاصی توکن (`maxSize`).
- برای ویدیو، مدت زمان <= `maxVideoSec` (و در هر صورت <= ۶۰ ثانیه).
- امکان استفاده از Redis برای قفل‌گذاری اختیاری جهت جلوگیری از پردازش همزمان فایل یکسان.
- لاگ‌ها با `winston` ساختارمند هستند و شامل شناسه درخواست، کاربر، نوع رسانه، و وضعیت می‌شوند.

## دیپلوی و زیرساخت
- سرویس پشت Nginx قرار می‌گیرد؛ فایل‌ها مستقیماً از Nginx با هدر cache طولانی سرو می‌شوند.
- توصیه: اجرای سرویس در Docker (تصویر مبتنی بر Node 18 + ffmpeg/ffprobe).
- پاکسازی دوره‌ای فایل‌های موقت با `npm run cleanup:tmp` (قابل زمان‌بندی با cron).

## توسعه و تست
- **مدیریت محیط**: مقداردهی متغیرها با `.env`; اعتبارسنجی با `zod`.
- **اسکریپت‌ها**:
  - `npm run dev`
  - `npm run lint`
  - `npm test`
  - `npm run cleanup:tmp`
  - `npm run verify:thumbs`
- **تست‌ها**:
  - یونیت برای MIME, پردازش رسانه، dedup.
  - E2E برای سناریوهای موفق و خطا (مثل ویدیو بیش از ۶۰ ثانیه).
## ?????? ??????? (Logging)
- ?????? ???????? ?? `winston` ????? ??????? ?????? ??? ????? ?????? ????? Filebeat/Vector ?? OpenSearch ???????, ????? ?? data ???? ????????? ????.
- event ???? ??? ???? `http.request`, `http.response`, `http.error` ????? `application.*` ????? ??????? ????? ??? ?????? ??????? ??????? ????? ????.
- ????? ??????? `RequestLoggingInterceptor` ??? ?? ??? ?? ??????? ????????? ??? ??? ??????? (`requestId`, `method`, `url`, `durationMs`, `statusCode`) ????? ??? ????????? ????? ??? ?????.
- ?????? ????? (`UploadService`, `UploadAuthService`, `ImageService`, `VideoService`, `MediaService`) ??????? ??????? ??????? ??? ????? ??? ?????? (???? ????? JWT، ????? dedup، ??????? thumbnail، ??????? ffmpeg) ??? ?? ????????? ?????? ????? ?? ???.
- ??????? ??????? ??? ??????? ??? ??? `LOG_LEVEL` (?????? ??? ???) ??? `info` ???? production ? `debug` ???? development ????? ?????????? ??? ?????.

## Nginx
نمونه کانفیگ در `docs/nginx.conf.sample` قرار گرفته است؛ کافی است مسیرهای `/o/` و `/t/` را به دایرکتوری‌های روی دیسک map کنید.

## Postman Collection
پکیج آماده‌ی Postman در `docs/file-storage.postman_collection.json` قرار دارد و شامل درخواست‌های `POST /upload` و `GET /media/:sha/meta` است. کافی است متغیر محیطی `baseUrl` را تنظیم کنید و JWT را در قسمت Authorization جایگزین کنید.
